#!/bin/sh

set -eu

_usage() {
  cat >&2 <<EOF
usage:
  myfreebsd bwdev
  myfreebsd bk
  myfreebsd bkdev
  myfreebsd ci
  myfreebsd dirdeps
EOF
  exit 64 # EX_USAGE
}

buildworld_dev() {
  # NOTE rebuilding world without ccache takes a while, so uncomment this only if you need it.
  #make -C "${src}" ${_make_args} cleanworld
  make -C "${src}" -j"${parallelism}" ${_make_args} buildworld
}

buildkernel_parallel() {
  make -C "${src}" ${_make_args} KERNCONF=SIVAKERN cleankernel
  make -C "${src}" -j"${parallelism}" -k ${_make_args} KERNCONF=SIVAKERN buildkernel
}

buildkernel_dev_single() {
  make -C "${src}" -j1 ${_make_args} KERNCONF=SIVAKERN buildkernel
}

dirdeps_build() {
  make -C "${src}" -j"${parallelism}" \
    __MAKE_CONF=${top}/dev/make.conf \
    SRCCONF=${top}/dev/src.conf \
    SRC_ENV_CONF=${top}/dev/dirdeps_src-env.conf \
    WITH_DIRDEPS_BUILD= \
    the-lot
}

_ci() {
  doas make -C "${src}/tests/ci" ${_make_args} "$@" clean || true
  doas make -C "${src}/tests/ci" ${_make_args} "$@" ci
  #make -C "${src}/tests/ci" ${_make_args} \
  #  -DNO_ROOT \
  #  TIMEOUT_MS="16200000" \
  #  "$@" \
  #  ci
}

_ci_parallel() {
  doas make -C "${src}/tests/ci" ${_make_args} clean || true
  doas make -C "${src}/tests/ci" ${_make_args} CITYPE=full ci-buildworld ci-buildkernel ci-buildimage

  _outdir="$(mktemp -d /tmp/siva.XXXXXX)"
  _make_runtest="make -C ${src}/tests/ci CITYPE=full PARALLEL_JOBS=2 VM_MEM_SIZE=2g ci-runtest-meta"
  tmux -f /dev/null \
  	new-session -d -s myfreebsdci "doas ${_make_runtest} KYUA_TEST_FILTERS='bin sbin' 2>&1 | tee ${_outdir}/1.log" \; \
  	split-window "doas ${_make_runtest} KYUA_TEST_FILTERS='etc share' 2>&1 | tee ${_outdir}/2.log" \; \
  	split-window -h "doas ${_make_runtest} KYUA_TEST_FILTERS='cddl' 2>&1 | tee ${_outdir}/3.log" \; \
  	split-window "doas ${_make_runtest} KYUA_TEST_FILTERS='include' 2>&1 | tee ${_outdir}/4.log" \; \
  	select-layout even-horizontal \; \
  	select-pane -t 0 \; \
  	split-window -v "doas ${_make_runtest} KYUA_TEST_FILTERS='lib' 2>&1 | tee ${_outdir}/5.log" \; \
  	select-pane -t 2 \; \
  	split-window -v "doas ${_make_runtest} KYUA_TEST_FILTERS='libexec' 2>&1 | tee ${_outdir}/6.log" \; \
  	select-pane -t 4 \; \
  	split-window -v "doas ${_make_runtest} KYUA_TEST_FILTERS='sys' 2>&1 | tee ${_outdir}/7.log" \; \
  	select-pane -t 6 \; \
  	split-window -v "doas ${_make_runtest} KYUA_TEST_FILTERS='usr.bin usr.sbin' 2>&1 | tee ${_outdir}/8.log"
  env -u TMUX tmux -f /dev/null attach-session -t myfreebsdci > /dev/null

  echo "All output logs are in ${_outdir}"
}

realpath="$(realpath "$0")"
top="$(dirname "${realpath}")"
src="${HOME}/src/freebsd-src"
_make_args="__MAKE_CONF=${top}/dev/make.conf MAKECONF=${top}/dev/make.conf SRCCONF=${top}/dev/src.conf SRC_ENV_CONF=${top}/dev/src-env.conf"

while getopts j: name
do
  case "${name}" in
    j) parallelism="${OPTARG}" ;;
    ?)
      echo "Usage: $0: [-j numjobs] command" >&2
      exit 64 # EX_USAGE
      ;;
    *) ;;
  esac
done
shift $((OPTIND - 1))
: "${parallelism:=$(nproc)}"

cmd="$1"
shift

case "${cmd}" in
  bwdev) buildworld_dev ;;
  bk) buildkernel_parallel ;;
  bkdev) buildkernel_dev_single ;;
  dirdeps) dirdeps_build ;;
  ci) _ci "$@" ;;
  parci) _ci_parallel "$@" ;;
  *)
      echo "ERROR: unrecognized command '${cmd}'" >&2
      _usage
esac
